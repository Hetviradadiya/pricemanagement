<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mobile Product Entry</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }
      input[type="number"],
      input[type="text"],
      input[type="date"] {
        width: 100px;
      }
      .table-responsive {
        max-height: 80vh;
        overflow: auto;
      }
      table th,
      table td {
        white-space: nowrap;
        vertical-align: middle;
      }
      .readonly-field {
        background-color: #e9ecef;
      }
    </style>
  </head>
  <body>
    <div class="container py-3">
      <h3 class="mb-3 text-center">üì¶ Product Entry</h3>

      <div class="table-responsive">
        <table
          class="table table-bordered table-hover align-middle"
          id="productTable"
        >
          <thead class="table-light">
            <tr>
              <th>Photo</th>
              <th>Name</th>
              <th>Size</th>
              <th>Code</th>
              <th>HSN</th>
              <th>MRP</th>
              <th>Payment Type</th>
              <th>Price</th>
              <th>Discount<br><small>(%/Price)</small></th>
              <th>Tax<br><small>(%/Price)</small></th>
              <th>Box</th>
              <th>Box Discount<br><small>(%/Price)</small></th>
              <th>Box Tax<br><small>(%/Price)</small></th>
              <th>Dealer Name</th>
              <th>Slol</th>
              <th>Date</th>
              <th>Dealer Price</th>
              <th>Dealer Discount<br><small>(%/Price)</small></th>
              <th>Dealer Tax<br><small>(%/Price)</small></th>
              <th>Dealer Box</th>
              <th>Dealer Box Discount<br><small>(%/Price)</small></th>
              <th>Dealer Box Tax<br><small>(%/Price)</small></th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="productList"></tbody>
        </table>
      </div>

      <button class="btn btn-primary mt-2 w-100" id="addProductBtn">
        + Add Product
      </button>
      <button class="btn btn-success mt-2 w-100" id="saveProductsBtn">
        üíæ Save Products
      </button>
      <button class="btn btn-secondary mt-2 w-100" id="cancelEditBtn" style="display: none;" onclick="cancelEdit()">
        ‚ùå Cancel Edit
      </button>
    </div>

    <script>
      let productCount = 0;
      let priceCount = 0;
      let sizeCount = 0;
      let editingProductId = null;

      function createInput(
        type = "text",
        value = "",
        classes = "form-control",
        extra = ""
      ) {
        return `<input type="${type}" class="${classes}" value="${value}" ${extra}>`;
      }

      function calc(value, percent) {
        const v = parseFloat(value || 0);
        const p = parseFloat(percent || 0);
        return ((v * p) / 100).toFixed(2);
      }

      // --- Add Dealer Row ---
      function addDealerRow(priceRow, productId, sizeId, priceId) {
        const dealerRow = document.createElement("tr");
        dealerRow.classList.add(
          `product_${productId}_size_${sizeId}_price_${priceId}_dealer`
        );

        dealerRow.innerHTML = `
        <td colspan="13"></td>
        <td>${createInput("text")}</td>
        <td>${createInput("text")}</td>
        <td>${createInput("date")}</td>
        <td>${createInput(
          "number",
          "",
          "form-control",
          'oninput="updateDealerCalc(this)"'
        )}</td>
        <td>
          <div>${createInput("number", "", "form-control", 'placeholder="%" oninput="updateDealerCalc(this)"')}</div>
          <small class="text-muted">‚Çπ${createInput("number", "", "form-control readonly-field", 'readonly tabindex="-1" style="font-size:10px;height:20px;"')}</small>
        </td>
        <td>
          <div>${createInput("number", "", "form-control", 'placeholder="%" oninput="updateDealerCalc(this)"')}</div>
          <small class="text-muted">‚Çπ${createInput("number", "", "form-control readonly-field", 'readonly tabindex="-1" style="font-size:10px;height:20px;"')}</small>
        </td>
        <td>${createInput(
          "number",
          "",
          "form-control",
          'oninput="updateDealerCalc(this)"'
        )}</td>
        <td>
          <div>${createInput("number", "", "form-control", 'placeholder="%" oninput="updateDealerCalc(this)"')}</div>
          <small class="text-muted">‚Çπ${createInput("number", "", "form-control readonly-field", 'readonly tabindex="-1" style="font-size:10px;height:20px;"')}</small>
        </td>
        <td>
          <div>${createInput("number", "", "form-control", 'placeholder="%" oninput="updateDealerCalc(this)"')}</div>
          <small class="text-muted">‚Çπ${createInput("number", "", "form-control readonly-field", 'readonly tabindex="-1" style="font-size:10px;height:20px;"')}</small>
        </td>    
        <td>
          <button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">üóë</button>
        </td>
        `;

        const existingDealers = document.querySelectorAll(
          `.product_${productId}_size_${sizeId}_price_${priceId}_dealer`
        );
        const insertAfter = existingDealers.length
          ? existingDealers[existingDealers.length - 1]
          : priceRow;
        insertAfter.parentNode.insertBefore(dealerRow, insertAfter.nextSibling);
      }

      // --- Add Price Row ---
      function addPriceRow(productId, sizeId) {
        const priceId = priceCount++;
        const priceRow = document.createElement("tr");
        priceRow.classList.add(`product_${productId}_size_${sizeId}_price`);
        priceRow.dataset.priceId = priceId;

        priceRow.innerHTML = `
        <td colspan="6"></td>
        <td>
          <select class="form-control">
            <option value="">Select Payment Type</option>
            <option value="cash">Cash</option>
            <option value="bill">Bill</option>
            <option value="sale_cash">Sale Cash</option>
            <option value="sale_bill">Sale Bill</option>
            <option value="frd_cash">Frd Cash</option>
            <option value="frd_bill">Frd Bill</option>
          </select>
        </td>
        <td>${createInput("number", "", "form-control", 'placeholder="Price" oninput="updatePriceCalc(this)"')}</td>
        <td>
          <div>${createInput("number", "", "form-control", 'placeholder="%" oninput="updatePriceCalc(this)"')}</div>
          <small class="text-muted">‚Çπ${createInput("number", "", "form-control readonly-field", 'readonly tabindex="-1" style="font-size:10px;height:20px;"')}</small>
        </td>
        <td>
          <div>${createInput("number", "", "form-control", 'placeholder="%" oninput="updatePriceCalc(this)"')}</div>
          <small class="text-muted">‚Çπ${createInput("number", "", "form-control readonly-field", 'readonly tabindex="-1" style="font-size:10px;height:20px;"')}</small>
        </td>
        <td>${createInput(
          "number",
          "",
          "form-control",
          'oninput="updatePriceCalc(this)"'
        )}</td>
        <td>
          <div>${createInput("number", "", "form-control", 'placeholder="%" oninput="updatePriceCalc(this)"')}</div>
          <small class="text-muted">‚Çπ${createInput("number", "", "form-control readonly-field", 'readonly tabindex="-1" style="font-size:10px;height:20px;"')}</small>
        </td>
        <td>
          <div>${createInput("number", "", "form-control", 'placeholder="%" oninput="updatePriceCalc(this)"')}</div>
          <small class="text-muted">‚Çπ${createInput("number", "", "form-control readonly-field", 'readonly tabindex="-1" style="font-size:10px;height:20px;"')}</small>
        </td>
        <td colspan="10">
          <button class="btn btn-sm btn-info" onclick="addDealerRow(this.closest('tr'),${productId},${sizeId},${priceId})">+ Dealer</button>
          <button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">üóë</button>
        </td>
        `;

        // Simple insertion logic: find the target size row and insert right after it
        const targetSizeRow = Array.from(document.querySelectorAll(`tr`)).find(row => 
          row.classList.contains(`product_${productId}_size`) && 
          row.dataset.sizeId == sizeId
        );
        
        if (targetSizeRow) {
          targetSizeRow.insertAdjacentElement('afterend', priceRow);
        } else {
          // Fallback: insert after product row
          const productRow = document.getElementById(`product_${productId}`);
          productRow.insertAdjacentElement('afterend', priceRow);
        }
      }

      // --- Add Size Row ---
      function addSizeRow(productId) {
        const sizeId = sizeCount++;
        const sizeRow = document.createElement("tr");
        sizeRow.classList.add(`product_${productId}_size`);
        sizeRow.dataset.sizeId = sizeId;
        sizeRow.innerHTML = `
          <td colspan="2"></td>
          <td>${createInput("text", "", "form-control", 'placeholder="Size"')}</td>
          <td>${createInput("text", "", "form-control", 'placeholder="Product Code"')}</td>
          <td>${createInput("text", "", "form-control", 'placeholder="HSN Code"')}</td>
          <td>${createInput("number", "", "form-control", 'placeholder="MRP" step="0.01"')}</td>
          <td colspan="17">
            <button class="btn btn-sm btn-success" onclick="addPriceRow(${productId},${sizeId})">+ Add Price</button>
            <button class="btn btn-sm btn-secondary" onclick="this.closest('tr').remove()">‚úñ Delete Size</button>
          </td>
        `;
        const productRow = document.getElementById(`product_${productId}`);
        productRow.parentNode.insertBefore(sizeRow, productRow.nextSibling);
      }

      // --- Add Product Row ---
      function addProductRow() {
        const tbody = document.getElementById("productList");
        const productId = productCount++;
        const productRow = document.createElement("tr");
        productRow.id = `product_${productId}`;
        productRow.innerHTML = `
        <td>${createInput("file")}</td>
        <td>${createInput("text")}</td>
        <td colspan="21">
          <button class="btn btn-sm btn-success" onclick="addSizeRow(${productId})">+ Add Size</button>
          <button class="btn btn-sm btn-secondary" onclick="this.closest('tr').remove()">‚úñ Delete Product</button>
        </td>
      `;
        tbody.appendChild(productRow);
      }

      // --- Price Calculations ---
      function updatePriceCalc(element) {
        const row = element.closest("tr");
        const cells = row.querySelectorAll("td");
        
        // Get values from specific cells by position
        const priceInput = cells[2]?.querySelector("input"); // Price column
        const discountPercentInput = cells[3]?.querySelector("div input"); // Discount % input
        const discountPriceInput = cells[3]?.querySelector("small input"); // Discount price display
        const taxPercentInput = cells[4]?.querySelector("div input"); // Tax % input  
        const taxPriceInput = cells[4]?.querySelector("small input"); // Tax price display
        
        const price = parseFloat(priceInput?.value || 0);
        const discountPercent = parseFloat(discountPercentInput?.value || 0);
        const taxPercent = parseFloat(taxPercentInput?.value || 0);
        
        const discountAmount = parseFloat(calc(price, discountPercent));
        const priceAfterDiscount = price - discountAmount;
        const taxAmount = parseFloat(calc(priceAfterDiscount, taxPercent));
        const finalTotal = priceAfterDiscount + taxAmount;
        
        // Show final price after discount in the small field under discount %
        if (discountPriceInput) {
          discountPriceInput.value = priceAfterDiscount.toFixed(2);
          console.log(`‚úÖ Discount calculation: ${price} - ${discountPercent}% = ‚Çπ${priceAfterDiscount.toFixed(2)}`);
        }
        // Show final price after tax in the small field under tax %
        if (taxPriceInput) {
          taxPriceInput.value = finalTotal.toFixed(2);
          console.log(`‚úÖ Tax calculation: ‚Çπ${priceAfterDiscount.toFixed(2)} + ${taxPercent}% tax = ‚Çπ${finalTotal.toFixed(2)}`);
        }
        
        console.log(`üîç Full calculation: Price: ${price}, Discount: ${discountPercent}% (‚Çπ${discountAmount}), Final after discount: ‚Çπ${priceAfterDiscount.toFixed(2)}, Tax: ${taxPercent}% (‚Çπ${taxAmount}), Final total: ‚Çπ${finalTotal.toFixed(2)}`);

        // Box calculations
        const boxQtyInput = cells[5]?.querySelector("input"); // Box quantity column
        const boxDiscountPercentInput = cells[6]?.querySelector("div input"); // Box Discount % input
        const boxDiscountPriceInput = cells[6]?.querySelector("small input"); // Box discount price display
        const boxTaxPercentInput = cells[7]?.querySelector("div input"); // Box Tax % input  
        const boxTaxPriceInput = cells[7]?.querySelector("small input"); // Box tax price display
        
        const boxQty = parseFloat(boxQtyInput?.value || 0);
        const boxDiscountPercent = parseFloat(boxDiscountPercentInput?.value || 0);
        const boxTaxPercent = parseFloat(boxTaxPercentInput?.value || 0);
        
        if (boxQty > 0) {
          const boxPrice = price * boxQty;
          const boxDiscountAmount = parseFloat(calc(boxPrice, boxDiscountPercent));
          const boxPriceAfterDiscount = boxPrice - boxDiscountAmount;
          const boxTaxAmount = parseFloat(calc(boxPriceAfterDiscount, boxTaxPercent));
          const boxFinalTotal = boxPriceAfterDiscount + boxTaxAmount;
          
          // Show final box price after discount
          if (boxDiscountPriceInput) boxDiscountPriceInput.value = boxPriceAfterDiscount.toFixed(2);
          // Show final box price after tax
          if (boxTaxPriceInput) boxTaxPriceInput.value = boxFinalTotal.toFixed(2);
        }
      }

      // --- Dealer Calculations ---
      function updateDealerCalc(element) {
        const row = element.closest("tr");
        const cells = row.querySelectorAll("td");
        
        // Dealer row structure: colspan="13", then dealer_name, slol, date, price, discount, tax, box, box_discount, box_tax, actions
        // So actual inputs start at index 1 (after the colspan)
        const dealerPriceInput = cells[4]?.querySelector("input"); // Dealer Price column (4th cell after colspan)
        const dealerDiscountPercentInput = cells[5]?.querySelector("div input"); // Dealer Discount % input
        const dealerDiscountPriceInput = cells[5]?.querySelector("small input"); // Dealer discount price display
        const dealerTaxPercentInput = cells[6]?.querySelector("div input"); // Dealer Tax % input  
        const dealerTaxPriceInput = cells[6]?.querySelector("small input"); // Dealer tax price display
        
        const purchasePrice = parseFloat(dealerPriceInput?.value || 0);
        const purchaseDiscountPercent = parseFloat(dealerDiscountPercentInput?.value || 0);
        const purchaseTaxPercent = parseFloat(dealerTaxPercentInput?.value || 0);
        
        const purchaseDiscountAmount = parseFloat(calc(purchasePrice, purchaseDiscountPercent));
        const purchasePriceAfterDiscount = purchasePrice - purchaseDiscountAmount;
        const purchaseTaxAmount = parseFloat(calc(purchasePriceAfterDiscount, purchaseTaxPercent));
        const purchaseFinalTotal = purchasePriceAfterDiscount + purchaseTaxAmount;
        
        // Show final price after discount in the small field under discount %
        if (dealerDiscountPriceInput) {
          dealerDiscountPriceInput.value = purchasePriceAfterDiscount.toFixed(2);
          console.log(`‚úÖ Dealer Discount: ${purchasePrice} - ${purchaseDiscountPercent}% = ‚Çπ${purchasePriceAfterDiscount.toFixed(2)}`);
        }
        // Show final price after tax in the small field under tax %
        if (dealerTaxPriceInput) {
          dealerTaxPriceInput.value = purchaseFinalTotal.toFixed(2);
          console.log(`‚úÖ Dealer Tax: ‚Çπ${purchasePriceAfterDiscount.toFixed(2)} + ${purchaseTaxPercent}% tax = ‚Çπ${purchaseFinalTotal.toFixed(2)}`);
        }

        // Purchase box calculations
        const dealerBoxQtyInput = cells[7]?.querySelector("input"); // Dealer Box quantity column
        const dealerBoxDiscountPercentInput = cells[8]?.querySelector("div input"); // Dealer Box Discount % input
        const dealerBoxDiscountPriceInput = cells[8]?.querySelector("small input"); // Dealer box discount price display
        const dealerBoxTaxPercentInput = cells[9]?.querySelector("div input"); // Dealer Box Tax % input  
        const dealerBoxTaxPriceInput = cells[9]?.querySelector("small input"); // Dealer box tax price display
        
        const purchaseBoxQty = parseFloat(dealerBoxQtyInput?.value || 0);
        const purchaseBoxDiscountPercent = parseFloat(dealerBoxDiscountPercentInput?.value || 0);
        const purchaseBoxTaxPercent = parseFloat(dealerBoxTaxPercentInput?.value || 0);
        
        if (purchaseBoxQty > 0) {
          const purchaseBoxPrice = purchasePrice * purchaseBoxQty;
          const purchaseBoxDiscountAmount = parseFloat(calc(purchaseBoxPrice, purchaseBoxDiscountPercent));
          const purchaseBoxPriceAfterDiscount = purchaseBoxPrice - purchaseBoxDiscountAmount;
          const purchaseBoxTaxAmount = parseFloat(calc(purchaseBoxPriceAfterDiscount, purchaseBoxTaxPercent));
          const purchaseBoxFinalTotal = purchaseBoxPriceAfterDiscount + purchaseBoxTaxAmount;
          
          // Show final box price after discount
          if (dealerBoxDiscountPriceInput) dealerBoxDiscountPriceInput.value = purchaseBoxPriceAfterDiscount.toFixed(2);
          // Show final box price after tax
          if (dealerBoxTaxPriceInput) dealerBoxTaxPriceInput.value = purchaseBoxFinalTotal.toFixed(2);
        }
      }

      document
        .getElementById("addProductBtn")
        .addEventListener("click", addProductRow);

            document
        .getElementById("saveProductsBtn")
        .addEventListener("click", () => {
          const data = [];
          const productRows = document.querySelectorAll(
            '#productList tr[id^="product_"]'
          );

          productRows.forEach((pRow) => {
            const productId = pRow.id.split("_")[1];
            const productInputs = pRow.querySelectorAll("input");
            
            // Create Product data
            const productData = {
              name: productInputs[1]?.value || "",
              sizes: []
            };

            // Get all size rows for this product
            const sizeRows = document.querySelectorAll(`.product_${productId}_size`);
            sizeRows.forEach(sizeRow => {
              const sizeId = sizeRow.dataset.sizeId;
              const sizeInputs = sizeRow.querySelectorAll("input");
              const sizeData = {
                size: sizeInputs[0]?.value || "",
                code: sizeInputs[1]?.value || "",
                hsn: sizeInputs[2]?.value || "",
                mrp: parseFloat(sizeInputs[3]?.value || 0),
                prices: [] // Prices now belong to ProductSize
              };

              // Get all price rows for this specific size
              const priceRows = document.querySelectorAll(`.product_${productId}_size_${sizeId}_price`);
              priceRows.forEach(priceRow => {
                const priceId = priceRow.dataset.priceId;
                const priceInputs = priceRow.querySelectorAll("input, select");
                const priceData = {
                  payment_type: priceInputs[0]?.value || "",
                  price: parseFloat(priceInputs[1]?.value || 0),
                  discount: parseFloat(priceInputs[2]?.value || 0),
                  discount_price: parseFloat(priceInputs[3]?.value || 0),
                  tax: parseFloat(priceInputs[4]?.value || 0),
                  tax_price: parseFloat(priceInputs[5]?.value || 0),
                  box: parseFloat(priceInputs[6]?.value || 0),
                  box_discount: parseFloat(priceInputs[7]?.value || 0),
                  box_discount_price: parseFloat(priceInputs[8]?.value || 0),
                  box_tax: parseFloat(priceInputs[9]?.value || 0),
                  box_tax_price: parseFloat(priceInputs[10]?.value || 0),
                  dealers: []
                };
                
                console.log(`üíæ Saving price data: Price=${priceData.price}, Discount=${priceData.discount}%, Discount_Price=‚Çπ${priceData.discount_price}, Tax=${priceData.tax}%, Tax_Price=‚Çπ${priceData.tax_price}`);

                // Get dealer rows for this price
                const dealerRows = document.querySelectorAll(`.product_${productId}_size_${sizeId}_price_${priceId}_dealer`);
                dealerRows.forEach(dealerRow => {
                  const dealerInputs = dealerRow.querySelectorAll("input");
                  const dealerData = {
                    dlr_name: dealerInputs[0]?.value || "",
                    slol: dealerInputs[1]?.value || "",
                    purchase_date: dealerInputs[2]?.value || "",
                    purchase_price: parseFloat(dealerInputs[3]?.value || 0),
                    purchase_discount: parseFloat(dealerInputs[4]?.value || 0),
                    purchase_discount_price: parseFloat(dealerInputs[5]?.value || 0),
                    purchase_tax: parseFloat(dealerInputs[6]?.value || 0),
                    purchase_tax_price: parseFloat(dealerInputs[7]?.value || 0),
                    purchase_box: parseFloat(dealerInputs[8]?.value || 0),
                    purchase_box_discount: parseFloat(dealerInputs[9]?.value || 0),
                    purchase_box_discount_price: parseFloat(dealerInputs[10]?.value || 0),
                    purchase_box_tax: parseFloat(dealerInputs[11]?.value || 0),
                    purchase_box_tax_price: parseFloat(dealerInputs[12]?.value || 0)
                  };
                  priceData.dealers.push(dealerData);
                });

                sizeData.prices.push(priceData);
              });

              productData.sizes.push(sizeData);
            });

            data.push(productData);
          });

          console.log("‚úÖ Final Data:", JSON.stringify(data, null, 2));

          // Check if we're in edit mode
          if (editingProductId) {
            // Update mode - send PUT request for single product
            if (data.length > 0) {
              const productData = data[0]; // Only update the first product
              updateProduct(editingProductId, productData);
            }
          } else {
            // Create mode - send POST requests for all products
            saveAllProducts(data);
          }
        });

      // Save all products function with proper async handling
      async function saveAllProducts(data) {
        let successCount = 0;
        let errorCount = 0;
        const totalProducts = data.length;
        
        console.log(`üíæ Starting to save ${totalProducts} products...`);
        
        // Show loading state
        const saveBtn = document.getElementById("saveProductsBtn");
        const originalText = saveBtn.textContent;
        saveBtn.textContent = "üíæ Saving...";
        saveBtn.disabled = true;
        
        try {
          // Use Promise.all to wait for all saves to complete
          const savePromises = data.map(async (productData, index) => {
            try {
              const response = await fetch("/api/product-create/", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "X-CSRFToken": getCookie("csrftoken"),
                },
                body: JSON.stringify(productData),
              });
              
              const result = await response.json();
              
              if (response.ok) {
                console.log(`‚úÖ Product ${index + 1} saved successfully:`, result);
                successCount++;
                return result;
              } else {
                console.error(`‚ùå Error saving product ${index + 1}:`, result);
                errorCount++;
                throw new Error(`Product ${index + 1}: ${JSON.stringify(result)}`);
              }
            } catch (err) {
              console.error(`‚ùå Network error for product ${index + 1}:`, err);
              errorCount++;
              throw err;
            }
          });
          
          // Wait for all save operations to complete
          await Promise.allSettled(savePromises);
          
          // Show results and refresh
          if (successCount > 0) {
            console.log(`‚úÖ Successfully saved ${successCount} out of ${totalProducts} products!`);
            
            // Show brief success indication on button
            saveBtn.textContent = "‚úÖ Saved!";
            saveBtn.className = "btn btn-success mt-2 w-100";
            
            // Clear the form after a brief delay
            setTimeout(() => {
              document.getElementById('productList').innerHTML = '';
              productCount = 0;
              sizeCount = 0;
              priceCount = 0;
              
              // Refresh the product display
              displayProductsWithNestedStructure();
              
              console.log(`üîÑ Page refreshed to show new products`);
            }, 1000);
          }
          
          if (errorCount > 0) {
            console.log(`‚ö†Ô∏è ${errorCount} products failed to save. Check console for details.`);
          }
          
        } catch (err) {
          console.error('‚ùå Unexpected error during save operation:', err);
        } finally {
          // Restore button state
          saveBtn.textContent = originalText;
          saveBtn.disabled = false;
        }
      }

      // Update product function
      async function updateProduct(productId, productData) {
        console.log(`üîß Updating product ID: ${productId}`);
        console.log(`üìù Product data:`, JSON.stringify(productData, null, 2));
        
        try {
          const url = `/api/product-create/${productId}/`;
          console.log(`üì° Sending PATCH request to: ${url}`);
          
          const response = await fetch(url, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify(productData),
          });
          
          console.log(`üì° Response status: ${response.status}`);
          console.log(`üì° Response headers:`, response.headers);
          
          const result = await response.json();
          console.log(`üìã Response data:`, result);
          
          if (response.ok) {
            console.log(`‚úÖ Product updated successfully!`);
            
            // Reset edit mode UI
            cancelEdit();
            
            // Reload the product list
            window.location.reload();
          } else {
            console.error(`‚ùå Error response status: ${response.status}`);
            console.error(`‚ùå Error response body:`, result);
          }
        } catch (err) {
          console.error(`‚ùå Network error updating product:`, err);
        }
      }

      // Cancel edit mode function
      function cancelEdit() {
        editingProductId = null;
        document.getElementById("saveProductsBtn").textContent = "üíæ Save Products";
        document.getElementById("saveProductsBtn").className = "btn btn-success mt-2 w-100";
        document.getElementById("cancelEditBtn").style.display = "none";
        document.getElementById('productList').innerHTML = '';
        productCount = 0;
        sizeCount = 0;
        priceCount = 0;
        console.log("‚úÖ Edit mode cancelled");
        
        // Refresh page to show product list
        displayProductsWithNestedStructure();
      }

      // Delete product function
      async function deleteProduct(productId) {
        console.log(`üóëÔ∏è Attempting to delete product ID: ${productId}`);
        
        // Get product name for better confirmation message
        let productName = "this product";
        try {
          const productRow = document.querySelector(`button[onclick="deleteProduct(${productId})"]`);
          if (productRow) {
            const nameCell = productRow.closest('tr').querySelector('td:nth-child(2)');
            if (nameCell && nameCell.textContent.trim()) {
              productName = `"${nameCell.textContent.trim()}"`;
            }
          }
        } catch (e) {
          // Fallback to generic message if we can't get the name
        }
        
        if (!confirm(`Are you sure you want to delete ${productName}?\n\nThis action cannot be undone and will remove all associated sizes, prices, and dealer information.`)) {
          console.log("‚ùå Delete cancelled by user");
          return;
        }
        
        // Find and disable all delete buttons temporarily
        const deleteButtons = document.querySelectorAll(`button[onclick="deleteProduct(${productId})"]`);
        deleteButtons.forEach(btn => {
          btn.disabled = true;
          btn.textContent = "üóë Deleting...";
        });
        
        try {
          const url = `/api/product-create/${productId}/`;
          console.log(`üì° Sending DELETE request to: ${url}`);
          
          const response = await fetch(url, {
            method: "DELETE",
            headers: {
              "X-CSRFToken": getCookie("csrftoken"),
            },
          });
          
          console.log(`üì° Delete response status: ${response.status}`);
          
          if (response.ok) {
            console.log("‚úÖ Product deleted successfully!");
            
            // Refresh the product display instead of full page reload
            displayProductsWithNestedStructure();
            console.log("üîÑ Product list refreshed after deletion");
          } else {
            const result = await response.json();
            console.error(`‚ùå Error deleting product (${response.status}):`, result);
            
            // Restore button state on error
            deleteButtons.forEach(btn => {
              btn.disabled = false;
              btn.textContent = "üóë Delete";
            });
          }
        } catch (err) {
          console.error("‚ùå Network error deleting product:", err);
          
          // Restore button state on error
          deleteButtons.forEach(btn => {
            btn.disabled = false;
            btn.textContent = "üóë Delete";
          });
        }
      }

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + "=")) {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }
      // Removed old incorrect display function

      // Override the display function to handle nested structure correctly
      function displayProductsWithNestedStructure() {
        fetch("/api/product-create/")
          .then((res) => res.json())
          .then((data) => {
            const tbody = document.getElementById("productList");
            tbody.innerHTML = ""; // clear old

            data.forEach((product) => {
              const sizes = product.sizes || [];

              // calculate total rows for product rowspan
              let totalRows = 0;
              sizes.forEach((size) => {
                const prices = size.prices || [];
                if (prices.length === 0) {
                  totalRows += 1; // size with no prices
                } else {
                  prices.forEach((price) => {
                    totalRows += Math.max((price.dealers && price.dealers.length) || 1, 1);
                  });
                }
              });
              if (totalRows === 0) totalRows = 1; // product with no sizes

              let currentRowIndex = 0;
              let firstProductRow = true;

              if (sizes.length > 0) {
                sizes.forEach((size, sIndex) => {
                  const prices = size.prices || [];
                  let sizeRowsCount = 0;
                  
                  // Calculate rows for this size
                  if (prices.length === 0) {
                    sizeRowsCount = 1;
                  } else {
                    prices.forEach((price) => {
                      sizeRowsCount += Math.max((price.dealers && price.dealers.length) || 1, 1);
                    });
                  }

                  let firstSizeRow = true;

                  if (prices.length > 0) {
                    prices.forEach((price, pIndex) => {
                      const dealers = price.dealers || [];
                      const priceRowspan = Math.max(dealers.length, 1);

                      if (dealers.length > 0) {
                        dealers.forEach((dealer, dIndex) => {
                          const tr = document.createElement("tr");
                          tr.innerHTML = `
                            ${firstProductRow ? `<td rowspan="${totalRows}">${product.photo ? `<img src="${product.photo}" alt="Photo" width="50">` : ""}</td>` : ""}
                            ${firstProductRow ? `<td rowspan="${totalRows}">${product.name || ""}</td>` : ""}
                            ${firstSizeRow ? `<td rowspan="${sizeRowsCount}">${size.size || ""}</td>` : ""}
                            ${firstSizeRow ? `<td rowspan="${sizeRowsCount}">${size.code || ""}</td>` : ""}
                            ${firstSizeRow ? `<td rowspan="${sizeRowsCount}">${size.hsn || ""}</td>` : ""}
                            ${firstSizeRow ? `<td rowspan="${sizeRowsCount}">${size.mrp || ""}</td>` : ""}
                            ${dIndex === 0 ? `<td rowspan="${priceRowspan}">${price.payment_type || ""}</td>` : ""}
                            ${dIndex === 0 ? `<td rowspan="${priceRowspan}">${price.price || ""}</td>` : ""}
                            ${dIndex === 0 ? `<td rowspan="${priceRowspan}"><div>${price.discount || ""}%</div><small class="text-muted">‚Çπ${price.discount_price || ""}</small></td>` : ""}
                            ${dIndex === 0 ? `<td rowspan="${priceRowspan}"><div>${price.tax || ""}%</div><small class="text-muted">‚Çπ${price.tax_price || ""}</small></td>` : ""}
                            ${dIndex === 0 ? `<td rowspan="${priceRowspan}">${price.box || ""}</td>` : ""}
                            ${dIndex === 0 ? `<td rowspan="${priceRowspan}"><div>${price.box_discount || ""}%</div><small class="text-muted">‚Çπ${price.box_discount_price || ""}</small></td>` : ""}
                            ${dIndex === 0 ? `<td rowspan="${priceRowspan}"><div>${price.box_tax || ""}%</div><small class="text-muted">‚Çπ${price.box_tax_price || ""}</small></td>` : ""}
                            <td>${dealer?.dlr_name || ""}</td>
                            <td>${dealer?.slol || ""}</td>
                            <td>${dealer?.purchase_date || ""}</td>
                            <td>${dealer?.purchase_price || ""}</td>
                            <td><div>${dealer?.purchase_discount || ""}%</div><small class="text-muted">‚Çπ${dealer?.purchase_discount_price || ""}</small></td>
                            <td><div>${dealer?.purchase_tax || ""}%</div><small class="text-muted">‚Çπ${dealer?.purchase_tax_price || ""}</small></td>
                            <td>${dealer?.purchase_box || ""}</td>
                            <td><div>${dealer?.purchase_box_discount || ""}%</div><small class="text-muted">‚Çπ${dealer?.purchase_box_discount_price || ""}</small></td>
                            <td><div>${dealer?.purchase_box_tax || ""}%</div><small class="text-muted">‚Çπ${dealer?.purchase_box_tax_price || ""}</small></td>
                            ${firstProductRow ? `<td rowspan="${totalRows}">
                              <button class="btn btn-sm btn-success" onclick="editProduct(${product.id})" title="Edit Product">‚úé Edit</button>
                              <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})" title="Delete Product">üóë Delete</button>
                            </td>` : ""}
                          `;
                          tbody.appendChild(tr);
                          firstProductRow = false;
                          firstSizeRow = false;
                        });
                      } else {
                        // Price with no dealers
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                          ${firstProductRow ? `<td rowspan="${totalRows}">${product.photo ? `<img src="${product.photo}" alt="Photo" width="50">` : ""}</td>` : ""}
                          ${firstProductRow ? `<td rowspan="${totalRows}">${product.name || ""}</td>` : ""}
                          ${firstSizeRow ? `<td rowspan="${sizeRowsCount}">${size.size || ""}</td>` : ""}
                          ${firstSizeRow ? `<td rowspan="${sizeRowsCount}">${size.code || ""}</td>` : ""}
                          ${firstSizeRow ? `<td rowspan="${sizeRowsCount}">${size.hsn || ""}</td>` : ""}
                          ${firstSizeRow ? `<td rowspan="${sizeRowsCount}">${size.mrp || ""}</td>` : ""}
                          <td>${price.payment_type || ""}</td>
                          <td>${price.price || ""}</td>
                          <td><div>${price.discount || ""}%</div><small class="text-muted">‚Çπ${price.discount_price || ""}</small></td>
                          <td><div>${price.tax || ""}%</div><small class="text-muted">‚Çπ${price.tax_price || ""}</small></td>
                          <td>${price.box || ""}</td>
                          <td><div>${price.box_discount || ""}%</div><small class="text-muted">‚Çπ${price.box_discount_price || ""}</small></td>
                          <td><div>${price.box_tax || ""}%</div><small class="text-muted">‚Çπ${price.box_tax_price || ""}</small></td>
                          <td colspan="9">No dealers</td>
                          ${firstProductRow ? `<td rowspan="${totalRows}">
                            <button class="btn btn-sm btn-success" onclick="editProduct(${product.id})" title="Edit Product">‚úé Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})" title="Delete Product">üóë Delete</button>
                          </td>` : ""}
                        `;
                        tbody.appendChild(tr);
                        firstProductRow = false;
                        firstSizeRow = false;
                      }
                    });
                  } else {
                    // Size with no prices
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                      ${firstProductRow ? `<td rowspan="${totalRows}">${product.photo ? `<img src="${product.photo}" alt="Photo" width="50">` : ""}</td>` : ""}
                      ${firstProductRow ? `<td rowspan="${totalRows}">${product.name || ""}</td>` : ""}
                      <td>${size.size || ""}</td>
                      <td>${size.code || ""}</td>
                      <td>${size.hsn || ""}</td>
                      <td>${size.mrp || ""}</td>
                      <td colspan="16">No prices defined</td>
                      ${firstProductRow ? `<td rowspan="${totalRows}">
                        <button class="btn btn-sm btn-success" onclick="editProduct(${product.id})" title="Edit Product">‚úé Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})" title="Delete Product">üóë Delete</button>
                      </td>` : ""}
                    `;
                    tbody.appendChild(tr);
                    firstProductRow = false;
                  }
                });
              } else {
                // Product with no sizes
                const tr = document.createElement("tr");
                tr.innerHTML = `
                  <td>${product.photo ? `<img src="${product.photo}" alt="Photo" width="50">` : ""}</td>
                  <td>${product.name || ""}</td>
                  <td colspan="20">No sizes defined</td>
                  <td>
                    <button class="btn btn-sm btn-success" onclick="editProduct(${product.id})" title="Edit Product">‚úé Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})" title="Delete Product">üóë Delete</button>
                  </td>
                `;
                tbody.appendChild(tr);
              }
            });
          })
          .catch((err) => console.error("Error loading products:", err));
      }

      // --- Edit Product Function ---
      function editProduct(productId) {
        console.log(`üîß Editing product ID: ${productId}`);
        
        // Fetch the specific product data
        fetch(`/api/product-create/`)
          .then(res => res.json())
          .then(products => {
            const product = products.find(p => p.id === productId);
            if (!product) {
              console.error('‚ùå Product not found!');
              return;
            }
            
            // Clear existing form and populate with product data
            populateFormWithProductData(product);
          })
          .catch(err => {
            console.error('‚ùå Error fetching product:', err);
          });
      }

      // --- Populate Form with Product Data ---
      function populateFormWithProductData(product) {
        // Clear existing form
        document.getElementById('productList').innerHTML = '';
        
        // Reset counters
        productCount = 0;
        sizeCount = 0;
        priceCount = 0;
        
        // Store the product ID for updating instead of creating new
        editingProductId = product.id;
        
        // Change UI to indicate edit mode
        document.getElementById("saveProductsBtn").textContent = "üîÑ Update Product";
        document.getElementById("saveProductsBtn").className = "btn btn-warning mt-2 w-100";
        document.getElementById("cancelEditBtn").style.display = "block";
        
        // Show a message to user that they're in edit mode
        console.log(`üìù Editing product: ${product.name} (ID: ${product.id})`);
        
        // Add product row first - this creates the basic structure
        addProductRow();
        
        // Fill in product basic info
        const productRow = document.getElementById('product_0');
        if (productRow) {
          const inputs = productRow.querySelectorAll('input');
          if (inputs.length >= 2) {
            inputs[0].value = product.photo || '';  // Photo input
            inputs[1].value = product.name || '';   // Name input
          }
        }
        
        // Add sizes, prices, and dealers using existing functions
        if (product.sizes && product.sizes.length > 0) {
          product.sizes.forEach((size, sizeIndex) => {
            // Add size row using existing function
            addSizeRow(0);
            
            // Fill size data
            const sizeRows = document.querySelectorAll('.product_0_size');
            const currentSizeRow = sizeRows[sizeIndex];
            
            if (currentSizeRow) {
              const sizeInputs = currentSizeRow.querySelectorAll('input');
              if (sizeInputs.length >= 4) {
                sizeInputs[0].value = size.size || '';
                sizeInputs[1].value = size.code || '';
                sizeInputs[2].value = size.hsn || '';
                sizeInputs[3].value = size.mrp || '';
              }
              
              // Add prices for this size
              if (size.prices && size.prices.length > 0) {
                size.prices.forEach((price, priceIndex) => {
                  // Add price row using existing function
                  addPriceRow(0, sizeIndex);
                  
                  // Fill price data
                  const priceRows = document.querySelectorAll(`.product_0_size_${sizeIndex}_price`);
                  const currentPriceRow = priceRows[priceIndex];
                  
                  if (currentPriceRow) {
                    const priceInputs = currentPriceRow.querySelectorAll('input, select');
                    
                    // Fill price inputs in order they appear in the addPriceRow function
                    let inputIndex = 0;
                    
                    // Payment type (select)
                    const paymentSelect = currentPriceRow.querySelector('select');
                    if (paymentSelect) paymentSelect.value = price.payment_type || 'cash';
                    
                    // Price inputs
                    const inputs = currentPriceRow.querySelectorAll('input');
                    if (inputs[inputIndex]) inputs[inputIndex].value = price.price || '';
                    inputIndex++;
                    if (inputs[inputIndex]) inputs[inputIndex].value = price.discount || '';
                    inputIndex++;
                    if (inputs[inputIndex]) inputs[inputIndex].value = price.discount_price || '';
                    inputIndex++;
                    if (inputs[inputIndex]) inputs[inputIndex].value = price.tax || '';
                    inputIndex++;
                    if (inputs[inputIndex]) inputs[inputIndex].value = price.tax_price || '';
                    inputIndex++;
                    if (inputs[inputIndex]) inputs[inputIndex].value = price.box || '';
                    inputIndex++;
                    if (inputs[inputIndex]) inputs[inputIndex].value = price.box_discount || '';
                    inputIndex++;
                    if (inputs[inputIndex]) inputs[inputIndex].value = price.box_discount_price || '';
                    inputIndex++;
                    if (inputs[inputIndex]) inputs[inputIndex].value = price.box_tax || '';
                    inputIndex++;
                    if (inputs[inputIndex]) inputs[inputIndex].value = price.box_tax_price || '';
                    
                    // Add dealers for this price
                    if (price.dealers && price.dealers.length > 0) {
                      price.dealers.forEach((dealer, dealerIndex) => {
                        // Add dealer row using existing function
                        addDealerRow(currentPriceRow, 0, sizeIndex, priceIndex);
                        
                        // Fill dealer data
                        const dealerRows = document.querySelectorAll(`.product_0_size_${sizeIndex}_price_${priceIndex}_dealer`);
                        const currentDealerRow = dealerRows[dealerIndex];
                        
                        if (currentDealerRow) {
                          const dealerInputs = currentDealerRow.querySelectorAll('input');
                          let dealerInputIndex = 0;
                          
                          if (dealerInputs[dealerInputIndex]) dealerInputs[dealerInputIndex].value = dealer.dlr_name || '';
                          dealerInputIndex++;
                          if (dealerInputs[dealerInputIndex]) dealerInputs[dealerInputIndex].value = dealer.slol || '';
                          dealerInputIndex++;
                          if (dealerInputs[dealerInputIndex]) dealerInputs[dealerInputIndex].value = dealer.purchase_date || '';
                          dealerInputIndex++;
                          if (dealerInputs[dealerInputIndex]) dealerInputs[dealerInputIndex].value = dealer.purchase_price || '';
                          dealerInputIndex++;
                          if (dealerInputs[dealerInputIndex]) dealerInputs[dealerInputIndex].value = dealer.purchase_discount || '';
                          dealerInputIndex++;
                          if (dealerInputs[dealerInputIndex]) dealerInputs[dealerInputIndex].value = dealer.purchase_discount_price || '';
                          dealerInputIndex++;
                          if (dealerInputs[dealerInputIndex]) dealerInputs[dealerInputIndex].value = dealer.purchase_tax || '';
                          dealerInputIndex++;
                          if (dealerInputs[dealerInputIndex]) dealerInputs[dealerInputIndex].value = dealer.purchase_tax_price || '';
                          dealerInputIndex++;
                          if (dealerInputs[dealerInputIndex]) dealerInputs[dealerInputIndex].value = dealer.purchase_box || '';
                          dealerInputIndex++;
                          if (dealerInputs[dealerInputIndex]) dealerInputs[dealerInputIndex].value = dealer.purchase_box_discount || '';
                          dealerInputIndex++;
                          if (dealerInputs[dealerInputIndex]) dealerInputs[dealerInputIndex].value = dealer.purchase_box_discount_price || '';
                          dealerInputIndex++;
                          if (dealerInputs[dealerInputIndex]) dealerInputs[dealerInputIndex].value = dealer.purchase_box_tax || '';
                          dealerInputIndex++;
                          if (dealerInputs[dealerInputIndex]) dealerInputs[dealerInputIndex].value = dealer.purchase_box_tax_price || '';
                        }
                      });
                    }
                  }
                });
              }
            }
          });
        }
        
        console.log('‚úÖ Product loaded into form for editing');
        
        // Scroll to top of form so user can see the loaded data
        document.getElementById('productTable').scrollIntoView({ behavior: 'smooth' });
      }

      // Call the correct function when page loads
      window.addEventListener("DOMContentLoaded", () => {
        displayProductsWithNestedStructure();
      });
      
    </script>
  </body>
</html>
