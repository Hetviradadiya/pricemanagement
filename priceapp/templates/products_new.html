<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Product Management System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }
      input[type="number"],
      input[type="text"],
      input[type="date"] {
        min-width: 80px;
        max-width: 120px;
      }
      .table-responsive {
        max-height: 85vh;
        overflow: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
      }
      table th,
      table td {
        white-space: nowrap;
        vertical-align: middle;
        font-size: 0.85rem;
        padding: 0.4rem;
      }
      .readonly-field {
        background-color: #e9ecef;
        cursor: not-allowed;
      }
      .product-row {
        background-color: #e3f2fd;
        font-weight: bold;
      }
      .size-row {
        background-color: #f3e5f5;
      }
      .price-row {
        background-color: #fff3e0;
      }
      .dealer-row {
        background-color: #e8f5e8;
      }
      .table th {
        background-color: #495057;
        color: white;
        position: sticky;
        top: 0;
        z-index: 10;
        font-size: 0.8rem;
      }
      .btn-sm {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
      }
      .form-control {
        font-size: 0.85rem;
        padding: 0.25rem 0.5rem;
      }
      .section-header {
        font-weight: bold;
        color: #495057;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid py-3">
      <h3 class="mb-3 text-center">ðŸ“¦ Product Management System</h3>

      <div class="table-responsive">
        <table
          class="table table-bordered table-hover align-middle"
          id="productTable"
        >
          <thead class="table-dark">
            <tr>
              <th rowspan="2">Photo</th>
              <th rowspan="2">Product Name</th>
              <th class="section-header" colspan="4">Product Size Details</th>
              <th class="section-header" colspan="5">Price Details</th>
              <th class="section-header" colspan="5">Box Details</th>
              <th class="section-header" colspan="10">Dealer Details</th>
              <th rowspan="2">Actions</th>
            </tr>
            <tr>
              <!-- Product Size Details -->
              <th>Size</th>
              <th>Code</th>
              <th>HSN</th>
              <th>MRP</th>
              
              <!-- Price Details -->
              <th>Payment Type</th>
              <th>Price</th>
              <th>Discount %</th>
              <th>Discount Price</th>
              <th>Tax %</th>
              <th>Tax Price</th>
              
              <!-- Box Details -->
              <th>Box Qty</th>
              <th>Box Discount %</th>
              <th>Box Discount Price</th>
              <th>Box Tax %</th>
              <th>Box Tax Price</th>
              
              <!-- Dealer Details -->
              <th>Dealer Name</th>
              <th>SLOL</th>
              <th>Purchase Date</th>
              <th>Purchase Price</th>
              <th>Purchase Discount %</th>
              <th>Purchase Discount Price</th>
              <th>Purchase Tax %</th>
              <th>Purchase Tax Price</th>
              <th>Purchase Box</th>
              <th>Purchase Box Discount %</th>
              <th>Purchase Box Discount Price</th>
              <th>Purchase Box Tax %</th>
              <th>Purchase Box Tax Price</th>
            </tr>
          </thead>
          <tbody id="productList"></tbody>
        </table>
      </div>

      <div class="row mt-3">
        <div class="col-md-6">
          <button class="btn btn-primary w-100" id="addProductBtn">
            + Add New Product
          </button>
        </div>
        <div class="col-md-6">
          <button class="btn btn-success w-100" id="saveProductsBtn">
            ðŸ’¾ Save All Products
          </button>
        </div>
      </div>
    </div>

    <script>
      let productCount = 0;
      let priceCount = 0;
      let sizeCount = 0;

      // --- Utility Functions ---
      function createInput(
        type = "text",
        value = "",
        classes = "form-control",
        extra = ""
      ) {
        return `<input type="${type}" class="${classes}" value="${value}" ${extra}>`;
      }

      function calc(value, percent) {
        const v = parseFloat(value || 0);
        const p = parseFloat(percent || 0);
        return ((v * p) / 100).toFixed(2);
      }

      // --- Price Calculations ---
      function updatePriceCalc(element) {
        const row = element.closest("tr");
        const price = parseFloat(row.querySelector("td:nth-child(8) input").value || 0);
        const discountPercent = parseFloat(row.querySelector("td:nth-child(9) input").value || 0);
        const taxPercent = parseFloat(row.querySelector("td:nth-child(11) input").value || 0);
        
        const discountPrice = calc(price, discountPercent);
        const priceAfterDiscount = price - discountPrice;
        const taxPrice = calc(priceAfterDiscount, taxPercent);
        
        row.querySelector("td:nth-child(10) input").value = discountPrice;
        row.querySelector("td:nth-child(12) input").value = taxPrice;

        // Box calculations
        const boxQty = parseFloat(row.querySelector("td:nth-child(13) input").value || 0);
        const boxDiscountPercent = parseFloat(row.querySelector("td:nth-child(14) input").value || 0);
        const boxTaxPercent = parseFloat(row.querySelector("td:nth-child(16) input").value || 0);
        
        if (boxQty > 0) {
          const boxPrice = price * boxQty;
          const boxDiscountPrice = calc(boxPrice, boxDiscountPercent);
          const boxPriceAfterDiscount = boxPrice - boxDiscountPrice;
          const boxTaxPrice = calc(boxPriceAfterDiscount, boxTaxPercent);
          
          row.querySelector("td:nth-child(15) input").value = boxDiscountPrice;
          row.querySelector("td:nth-child(17) input").value = boxTaxPrice;
        }
      }

      // --- Dealer Calculations ---
      function updateDealerCalc(element) {
        const row = element.closest("tr");
        const purchasePrice = parseFloat(row.querySelector("td:nth-child(21) input").value || 0);
        const purchaseDiscountPercent = parseFloat(row.querySelector("td:nth-child(22) input").value || 0);
        const purchaseTaxPercent = parseFloat(row.querySelector("td:nth-child(24) input").value || 0);
        
        const purchaseDiscountPrice = calc(purchasePrice, purchaseDiscountPercent);
        const purchasePriceAfterDiscount = purchasePrice - purchaseDiscountPrice;
        const purchaseTaxPrice = calc(purchasePriceAfterDiscount, purchaseTaxPercent);
        
        row.querySelector("td:nth-child(23) input").value = purchaseDiscountPrice;
        row.querySelector("td:nth-child(25) input").value = purchaseTaxPrice;

        // Purchase box calculations
        const purchaseBoxQty = parseFloat(row.querySelector("td:nth-child(26) input").value || 0);
        const purchaseBoxDiscountPercent = parseFloat(row.querySelector("td:nth-child(27) input").value || 0);
        const purchaseBoxTaxPercent = parseFloat(row.querySelector("td:nth-child(29) input").value || 0);
        
        if (purchaseBoxQty > 0) {
          const purchaseBoxPrice = purchasePrice * purchaseBoxQty;
          const purchaseBoxDiscountPrice = calc(purchaseBoxPrice, purchaseBoxDiscountPercent);
          const purchaseBoxPriceAfterDiscount = purchaseBoxPrice - purchaseBoxDiscountPrice;
          const purchaseBoxTaxPrice = calc(purchaseBoxPriceAfterDiscount, purchaseBoxTaxPercent);
          
          row.querySelector("td:nth-child(28) input").value = purchaseBoxDiscountPrice;
          row.querySelector("td:nth-child(30) input").value = purchaseBoxTaxPrice;
        }
      }

      // --- Add Dealer Row ---
      function addDealerRow(priceRow, productId, sizeId, priceId) {
        const dealerId = Date.now();
        const dealerRow = document.createElement("tr");
        dealerRow.classList.add(
          `product_${productId}_size_${sizeId}_price_${priceId}_dealer`,
          "dealer-row"
        );

        dealerRow.innerHTML = `
        <td colspan="17"></td>
        <td>${createInput("text", "", "form-control", 'placeholder="Dealer Name"')}</td>
        <td>${createInput("text", "", "form-control", 'placeholder="SLOL"')}</td>
        <td>${createInput("date", "", "form-control")}</td>
        <td>${createInput(
          "number",
          "",
          "form-control",
          'placeholder="Purchase Price" step="0.01" oninput="updateDealerCalc(this)"'
        )}</td>
        <td>${createInput(
          "number",
          "",
          "form-control",
          'placeholder="Discount %" step="0.01" oninput="updateDealerCalc(this)"'
        )}</td>
        <td>${createInput(
          "number",
          "",
          "form-control readonly-field",
          "readonly placeholder='Auto Calculated'"
        )}</td>
        <td>${createInput(
          "number",
          "",
          "form-control",
          'placeholder="Tax %" step="0.01" oninput="updateDealerCalc(this)"'
        )}</td>
        <td>${createInput(
          "number",
          "",
          "form-control readonly-field",
          "readonly placeholder='Auto Calculated'"
        )}</td>
        <td>${createInput(
          "number",
          "",
          "form-control",
          'placeholder="Box Qty" step="1" oninput="updateDealerCalc(this)"'
        )}</td>
        <td>${createInput(
          "number",
          "",
          "form-control",
          'placeholder="Box Discount %" step="0.01" oninput="updateDealerCalc(this)"'
        )}</td>
        <td>${createInput(
          "number",
          "",
          "form-control readonly-field",
          "readonly placeholder='Auto Calculated'"
        )}</td>
        <td>${createInput(
          "number",
          "",
          "form-control",
          'placeholder="Box Tax %" step="0.01" oninput="updateDealerCalc(this)"'
        )}</td>
        <td>${createInput(
          "number",
          "",
          "form-control readonly-field",
          "readonly placeholder='Auto Calculated'"
        )}</td>
        <td>
          <button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">ðŸ—‘ Delete</button>
        </td>
        `;

        priceRow.parentNode.insertBefore(dealerRow, priceRow.nextSibling);
      }

      // --- Add Price Row ---
      function addPriceRow(productId, sizeId) {
        const priceId = priceCount++;
        const priceRow = document.createElement("tr");
        priceRow.classList.add(`product_${productId}_size_${sizeId}_price`, "price-row");
        priceRow.dataset.priceId = priceId;

        priceRow.innerHTML = `
        <td colspan="6"></td>
        <td>
          <select class="form-control">
            <option value="">Select Payment Type</option>
            <option value="cash">Cash</option>
            <option value="bill">Bill</option>
            <option value="sale_cash">Sale Cash</option>
            <option value="sale_bill">Sale Bill</option>
            <option value="frd_cash">Frd Cash</option>
            <option value="frd_bill">Frd Bill</option>
          </select>
        </td>
        <td>${createInput(
          "number",
          "",
          "form-control",
          'placeholder="Selling Price" step="0.01" oninput="updatePriceCalc(this)"'
        )}</td>
        <td>${createInput(
          "number",
          "",
          "form-control",
          'placeholder="Discount %" step="0.01" oninput="updatePriceCalc(this)"'
        )}</td>
        <td>${createInput(
          "number",
          "",
          "form-control readonly-field",
          "readonly placeholder='Auto Calculated'"
        )}</td>
        <td>${createInput(
          "number",
          "",
          "form-control",
          'placeholder="Tax %" step="0.01" oninput="updatePriceCalc(this)"'
        )}</td>
        <td>${createInput(
          "number",
          "",
          "form-control readonly-field",
          "readonly placeholder='Auto Calculated'"
        )}</td>
        <td>${createInput(
          "number",
          "",
          "form-control",
          'placeholder="Box Qty" step="1" oninput="updatePriceCalc(this)"'
        )}</td>
        <td>${createInput(
          "number",
          "",
          "form-control",
          'placeholder="Box Discount %" step="0.01" oninput="updatePriceCalc(this)"'
        )}</td>
        <td>${createInput(
          "number",
          "",
          "form-control readonly-field",
          "readonly placeholder='Auto Calculated'"
        )}</td>
        <td>${createInput(
          "number",
          "",
          "form-control",
          'placeholder="Box Tax %" step="0.01" oninput="updatePriceCalc(this)"'
        )}</td>
        <td>${createInput(
          "number",
          "",
          "form-control readonly-field",
          "readonly placeholder='Auto Calculated'"
        )}</td>
        <td colspan="13">
          <button class="btn btn-sm btn-info me-2" onclick="addDealerRow(this.closest('tr'),${productId},${sizeId},${priceId})">+ Add Dealer</button>
          <button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()">ðŸ—‘ Delete Price</button>
        </td>
        `;

        const sizeRows = document.querySelectorAll(
          `.product_${productId}_size_${sizeId}`
        );
        const insertAfter =
          sizeRows[sizeRows.length - 1] ||
          document.getElementById(`product_${productId}`);
        insertAfter.parentNode.insertBefore(priceRow, insertAfter.nextSibling);
      }

      // --- Add Size Row ---
      function addSizeRow(productId) {
        const sizeId = sizeCount++;
        const sizeRow = document.createElement("tr");
        sizeRow.classList.add(`product_${productId}_size`, "size-row");
        sizeRow.dataset.sizeId = sizeId;
        sizeRow.innerHTML = `
          <td colspan="2"></td>
          <td>${createInput("text", "", "form-control", 'placeholder="Size/Variant"')}</td>
          <td>${createInput("text", "", "form-control", 'placeholder="Product Code"')}</td>
          <td>${createInput("text", "", "form-control", 'placeholder="HSN Code"')}</td>
          <td>${createInput("number", "", "form-control", 'placeholder="MRP" step="0.01"')}</td>
          <td colspan="25">
            <button class="btn btn-sm btn-success me-2" onclick="addPriceRow(${productId},${sizeId})">+ Add Price</button>
            <button class="btn btn-sm btn-secondary" onclick="this.closest('tr').remove()">âœ– Delete Size</button>
          </td>
        `;
        const productRow = document.getElementById(`product_${productId}`);
        productRow.parentNode.insertBefore(sizeRow, productRow.nextSibling);
      }

      // --- Add Product Row ---
      function addProductRow() {
        const productId = productCount++;
        const productRow = document.createElement("tr");
        productRow.classList.add("product-row");
        productRow.id = `product_${productId}`;
        productRow.innerHTML = `
          <td>
            <input type="file" class="form-control form-control-sm" accept="image/*">
          </td>
          <td>${createInput("text", "", "form-control", 'placeholder="Product Name" required')}</td>
          <td colspan="29">
            <button class="btn btn-sm btn-primary me-2" onclick="addSizeRow(${productId})">+ Add Size</button>
            <button class="btn btn-sm btn-danger" onclick="deleteProduct(${productId})">ðŸ—‘ Delete Product</button>
          </td>
        `;
        document.getElementById("productList").appendChild(productRow);
      }

      // --- Delete Product ---
      function deleteProduct(productId) {
        // Remove product row and all related rows
        const rows = document.querySelectorAll(`[class*="product_${productId}"]`);
        rows.forEach(row => row.remove());
        document.getElementById(`product_${productId}`).remove();
      }

      // --- Collect All Data ---
      function collectProductData() {
        const products = [];
        const productRows = document.querySelectorAll(".product-row");
        
        productRows.forEach((productRow, index) => {
          const productId = productRow.id.split('_')[1];
          const productData = {
            id: productId,
            photo: productRow.querySelector("input[type=file]").files[0] || null,
            name: productRow.querySelector("input[type=text]").value,
            sizes: []
          };

          // Get all size rows for this product
          const sizeRows = document.querySelectorAll(`.product_${productId}_size`);
          sizeRows.forEach(sizeRow => {
            const sizeId = sizeRow.dataset.sizeId;
            const sizeInputs = sizeRow.querySelectorAll("input");
            const sizeData = {
              id: sizeId,
              size: sizeInputs[0]?.value || "",
              code: sizeInputs[1]?.value || "",
              hsn: sizeInputs[2]?.value || "",
              mrp: parseFloat(sizeInputs[3]?.value || 0),
              prices: []
            };

            // Get all price rows for this size
            const priceRows = document.querySelectorAll(`.product_${productId}_size_${sizeId}_price`);
            priceRows.forEach(priceRow => {
              const priceId = priceRow.dataset.priceId;
              const priceInputs = priceRow.querySelectorAll("input, select");
              const priceData = {
                id: priceId,
                payment_type: priceInputs[0]?.value || "",
                price: parseFloat(priceInputs[1]?.value || 0),
                discount: parseFloat(priceInputs[2]?.value || 0),
                discount_price: parseFloat(priceInputs[3]?.value || 0),
                tax: parseFloat(priceInputs[4]?.value || 0),
                tax_price: parseFloat(priceInputs[5]?.value || 0),
                box: parseFloat(priceInputs[6]?.value || 0),
                box_discount: parseFloat(priceInputs[7]?.value || 0),
                box_discount_price: parseFloat(priceInputs[8]?.value || 0),
                box_tax: parseFloat(priceInputs[9]?.value || 0),
                box_tax_price: parseFloat(priceInputs[10]?.value || 0),
                dealers: []
              };

              // Get all dealer rows for this price
              const dealerRows = document.querySelectorAll(`.product_${productId}_size_${sizeId}_price_${priceId}_dealer`);
              dealerRows.forEach(dealerRow => {
                const dealerInputs = dealerRow.querySelectorAll("input");
                const dealerData = {
                  dlr_name: dealerInputs[0]?.value || "",
                  slol: dealerInputs[1]?.value || "",
                  purchase_date: dealerInputs[2]?.value || "",
                  purchase_price: parseFloat(dealerInputs[3]?.value || 0),
                  purchase_discount: parseFloat(dealerInputs[4]?.value || 0),
                  purchase_discount_price: parseFloat(dealerInputs[5]?.value || 0),
                  purchase_tax: parseFloat(dealerInputs[6]?.value || 0),
                  purchase_tax_price: parseFloat(dealerInputs[7]?.value || 0),
                  purchase_box: parseFloat(dealerInputs[8]?.value || 0),
                  purchase_box_discount: parseFloat(dealerInputs[9]?.value || 0),
                  purchase_box_discount_price: parseFloat(dealerInputs[10]?.value || 0),
                  purchase_box_tax: parseFloat(dealerInputs[11]?.value || 0),
                  purchase_box_tax_price: parseFloat(dealerInputs[12]?.value || 0)
                };
                priceData.dealers.push(dealerData);
              });

              sizeData.prices.push(priceData);
            });

            productData.sizes.push(sizeData);
          });

          products.push(productData);
        });

        return products;
      }

      // --- Save Products ---
      function saveProducts() {
        const products = collectProductData();
        console.log("Products to save:", products);
        
        // Here you would typically send the data to your backend
        // Example:
        // fetch('/api/save-products/', {
        //   method: 'POST',
        //   headers: {
        //     'Content-Type': 'application/json',
        //     'X-CSRFToken': getCookie('csrftoken')
        //   },
        //   body: JSON.stringify(products)
        // });
        
        alert(`Ready to save ${products.length} products!`);
      }

      // --- Event Listeners ---
      document.getElementById("addProductBtn").addEventListener("click", addProductRow);
      document.getElementById("saveProductsBtn").addEventListener("click", saveProducts);

      // Initialize with one product row
      addProductRow();
    </script>
  </body>
</html>